Ext.ns("Xap").Format={formatTime:function(c){var b=c/1000,a=Math.floor(b/60),d=Math.floor(b%60);return Ext.String.format("{0}:{1}",a,d<10?"0"+d:d)}};Ext.ns("Xap").Format={formatTime:function(c){var b=c/1000,a=Math.floor(b/60),d=Math.floor(b%60);return Ext.String.format("{0}:{1}",a,d<10?"0"+d:d)}};Ext.ns("Xap").Templates={trackInfo:new Ext.XTemplate('<p class="xap-time-elapsed">{position:this.formatPosition}</p>','<div class="xap-id3">','<p class="xap-artist">{artist:defaultValue("Unknown")}</p>','<p class="xap-title">{title:defaultValue("Unknown")}</p>',"</div>",'<p class="xap-time-total">{duration:this.formatDuration}</p>',{formatPosition:function(a){return Xap.Format.formatTime(a||0)},formatDuration:function(a){return a?Xap.Format.formatTime(a):""}})};Ext.define("Xap.TrackInfo",{extend:"Ext.panel.Panel",alias:"widget.xap.trackinfo",requires:["Xap.Templates"],height:56,tpl:Xap.Templates.trackInfo,cls:"xap-trackinfo",initComponent:function(){this.info={};this.callParent(arguments)},set:function(a){this.update(Ext.apply(this.info,a))},clear:function(){(new Ext.core.Element(this.body)).update("")}});Ext.define("Xap.TrackSlider",{extend:"Ext.slider.Single",alias:"widget.xap.trackslider",animate:false,width:290,value:0,increment:1,minValue:0,maxValue:0,cls:"xap-trackslider",tipText:function(a){return Xap.Format.formatTime(a.value)}});Ext.define("Xap.VolumeSlider",{extend:"Ext.slider.Single",alias:"widget.xap.volumeslider",animate:false,width:64,value:0,increment:1,minValue:0,maxValue:100,cls:"xap-volumeslider",tipText:function(a){return a.value+"%"}});Ext.regModel("Track",{fields:["url","artist","title","duration","album","smSound"]});Ext.define("Xap.Playlist",{extend:"Ext.grid.GridPanel",alias:"widget.xap.playlist",showArtist:true,height:200,width:300,border:0,cls:"xap-playlist",sortableHeaders:false,constructor:function(){this.addEvents("trackselect");this.callParent(arguments)},initComponent:function(){var b=this,a=[{header:"Track",dataIndex:"title",flex:1,menuDisabled:true}];if(b.showArtist){a.push({header:"Artist",dataIndex:"artist",flex:1,menuDisabled:true})}if(b.showTime){a.push({header:"Time",dataIndex:"duration",renderer:b.renderTime,width:35,menuDisabled:true})}if(b.showAlbum){a.push({header:"Album",dataIndex:"album",flex:1,menuDisabled:true})}Ext.apply(b,{columns:a,selModel:Ext.create("Ext.selection.RowModel",{enableKeyNav:false,listeners:{select:{fn:b.onSelect,scope:b}}})});b.callParent(arguments)},moveTo:function(a){this.getSelectionModel().select(a)},onSelect:function(c,a,b){this.fireEvent("trackselect",b)},renderTime:function(a){return a?Xap.Format.formatTime(a):""}});Ext.define("Xap.Player",{extend:"Ext.panel.Panel",alias:"widget.xap.player",requires:["Xap.TrackInfo","Xap.TrackSlider","Xap.VolumeSlider","Xap.Playlist"],statics:{autoSid:0},volume:75,lazy:true,height:121,width:300,cls:"xap-player",layout:"anchor",initComponent:function(){var b=this,c=new Xap.TrackInfo(),a=new Xap.TrackSlider({listeners:{render:{fn:b.disableSlider,scope:b},dragstart:{fn:b.onTrackSliderDragStart,scope:b},changecomplete:{fn:b.onTrackSliderChangeComplete,scope:b}}});Ext.apply(b,{trackInfo:c,trackSlider:a,store:new Ext.data.Store({model:"Track"}),items:[c,a],bbar:b.initBottomBar()});b.callParent(arguments)},initBottomBar:function(){var f=this,c=Ext.button.Button,b=f.playlistButton=new c({tooltip:"Playlist",cls:"xap-arrow-up",handler:f.togglePlaylist,scope:f}),d=f.playButton=new c({tooltip:"Play|Pause",cls:"xap-play",handler:f.togglePause,scope:f}),j=f.muteButton=new c({tooltip:"Mute|Unmute",cls:"xap-unmuted",handler:f.toggleMute,scope:f}),g=f.prevButton=new c({tooltip:"Previous",cls:"xap-prev",handler:f.movePrev,scope:f}),h=f.nextButton=new c({tooltip:"Next",cls:"xap-next",handler:f.moveNext,scope:f}),a=f.onVolumeSliderChange,i=f.volumeSlider=new Xap.VolumeSlider({value:f.volume,listeners:{render:{fn:f.disableSlider,scope:f},drag:{fn:a,scope:f},changecomplete:{fn:a,scope:f}}}),e=function(k){return{xtype:"tbspacer",width:k}};return[e(4),b,e(92),g,e(3),d,e(3),h,"->",j,e(2),i,e(6)]},afterRender:function(){var b=this,a=b.getEl(),c=b.playlist=Ext.create("Xap.Playlist",Ext.apply(b.playlistConfig||{},{store:b.store,listeners:{trackselect:{fn:b.onPlaylistTrackSelect,scope:b},itemmousedown:{fn:b.onPlaylistItemMousedown,scope:b}},renderTo:a.parent()}));b.callParent(arguments);if(!b.showPlaylist){b.togglePlaylist()}c.alignTo(a,"tl-bl");if(b.files){if(b.autoPlay){b.loadAndPlay(b.files)}else{b.load(b.files)}}},loadAndPlay:function(c){var b=this,a=b.store.getCount();b.load(c);b.moveTo(a);b.play()},load:function(b){var a=this;Ext.Array.forEach(b,function(d){var c=a.createSmSound(d,true);c.load();a.store.add({url:d,smSound:c})});if(!Ext.isNumber(a.currentTrackIndex)){a.moveTo(0)}a.trackSlider.enable();a.volumeSlider.enable()},unload:function(d){var c=this,a=c.store,b;if(!d){a.each(function(e){c.unload(e.get("url"))})}if(Ext.isArray(d)){Ext.Array.forEach(d,function(e){c.unload(e)})}b=c.getTrackIndexByUrl(d);if(b===c.currentTrackIndex){c.moveNext();c.currentTrackIndex=Math.min(c.currentTrackIndex-1,0)}if(b<c.currentTrackIndex){c.currentTrackIndex--}a.getAt(b).get("smSound").destruct();a.removeAt(b);if(a.getCount()===0){this.trackSlider.disable();this.volumeSlider.disable()}},togglePause:function(){var a=this;if(a.getCurrentSmSound()){if(a.isPlaying()){a.pause()}else{a.play()}}},pause:function(){var b=this,a=b.getCurrentSmSound();if(b.isPlaying()){a.pause();b.playButton.removeCls("xap-pause");b.playButton.addCls("xap-play")}},play:function(){var b=this,a=b.getCurrentSmSound();if(!b.isPlaying()){a.play();b.playButton.removeCls("xap-play");b.playButton.addCls("xap-pause")}},stop:function(){var a=this.getCurrentSmSound();if(a){a.stop()}},mute:function(){this.getCurrentSmSound().mute();this.muteButton.removeCls("xap-unmuted");this.muteButton.addCls("xap-muted");this.volumeSlider.setValue(0)},unmute:function(){var b=this,a=b.getCurrentSmSound();b.getCurrentSmSound().unmute();b.muteButton.removeCls("xap-muted");b.muteButton.addCls("xap-unmuted");b.volumeSlider.setValue(a.volume)},toggleMute:function(){if(this.getCurrentSmSound().muted){this.unmute()}else{this.mute()}},movePrev:function(){var b=this,a=b.currentTrackIndex;if(a===0){if(b.repeat){b.moveTo(b.store.getCount()-1)}else{return false}}else{b.moveTo(a-1)}return true},moveNext:function(){var b=this,a=b.currentTrackIndex;if(a===b.store.getCount()-1){if(b.repeat){b.moveTo(0)}else{return false}}else{b.moveTo(a+1)}return true},moveTo:function(c){var d=this,a=d.getCurrentSmSound(),f=d.isPlaying(),e=a&&(a.muted),b=d.prevButton,g=d.nextButton;d.stop();d.currentTrackIndex=c;a=d.getCurrentSmSound();a.load();d.updateTrackPosition(0);d.updateTrackInfoDisplay();if(a.loaded){d.setTrackDuration(a,true)}else{d.setTrackDuration(a)}d.onVolumeSliderChange(d.volumeSlider);if(!d.repeat){if(c===0){b.disable();g.enable()}else{if(c===d.store.getCount()-1){g.disable();b.enable()}else{b.enable();g.enable()}}}if(e){d.mute()}if(f){d.play()}d.playlist.moveTo(c)},createSmSound:function(a){var b=this,c=function(d){return function(){d.call(b,this)}};return soundManager.createSound({id:"xap-sound-"+this.self.autoSid++,url:a,onload:c(b.onLoad),onid3:c(b.onId3),whileloading:c(b.onWhileLoading),whileplaying:c(b.onWhilePlaying),onfinish:c(b.onTrackFinish)})},updateTrackInfoDisplay:function(){this.trackInfo.set(this.getId3Info(this.getCurrentSmSound()))},getId3Info:function(a){var b=a.id3;return{artist:b.TPE1,title:b.TIT2,album:b.TALB,duration:b.TLEN}},onId3:function(b){var a=this.getTrackByUrl(b.url);a.set(this.getId3Info(b));a.commit();if(this.isCurrentSmSound(b)){this.updateTrackInfoDisplay()}else{if(this.lazy){b.unload()}}},onWhileLoading:function(a){if(!a.id3.TLEN){this.setTrackDuration(a)}},onLoad:function(a){this.setTrackDuration(a,true)},setTrackDuration:function(b,d){var c=d?b.duration:b.durationEstimate||0,a=this.getTrackByUrl(b.url);a.set({duration:c});a.commit();if(this.isCurrentSmSound(b)){this.updateTrackDurationDisplay(c)}},updateTrackDurationDisplay:function(a){this.trackInfo.set({duration:a});this.trackSlider.setMaxValue(a)},updateTrackPosition:function(a){if(!Ext.isNumber(a)){a=this.getCurrentSmSound().position}if(!this.isSliderDragging){this.trackInfo.set({position:a});this.trackSlider.setValue(a)}},onWhilePlaying:function(a){this.updateTrackPosition()},onTrackSliderDragStart:function(a,b){this.isSliderDragging=true},onTrackSliderChangeComplete:function(b){var a=b.getValue();this.isSliderDragging=false;this.getCurrentSmSound().setPosition(b.getValue());if(a===0){this.updateTrackPosition(0)}},onVolumeSliderChange:function(b){var a=this.getCurrentSmSound();a.setVolume(b.getValue());this.unmute()},onTrackFinish:function(a){var b=this;if(b.moveNext()){b.play()}else{b.moveTo(0);b.playButton.removeCls("xap-pause");b.playButton.addCls("xap-play")}},disableSlider:function(a){if(!this.getCurrentSmSound()){a.disable()}},getCurrentSmSound:function(){var a=this.store.getAt(this.currentTrackIndex);return a?a.get("smSound"):null},isCurrentSmSound:function(a){return a===this.getCurrentSmSound()},getTrackByUrl:function(a){return this.store.findRecord("url",a,0,false,true,true)},getTrackIndexByUrl:function(a){return this.store.find("url",a,0,false,true,true)},togglePlaylist:function(){var a=this,c=a.playlist,b=a.playlistButton;if(c.isHidden()){c.show();b.removeCls("xap-arrow-down");b.addCls("xap-arrow-up")}else{c.hide();b.removeCls("xap-arrow-up");b.addCls("xap-arrow-down")}},isPlaying:function(){var a=this.getCurrentSmSound();return a&&a.playState===1&&!a.paused},onTrackSelect:function(a){this.moveTo(a);this.play()},onPlaylistTrackSelect:function(a){this.moveTo(a)},onPlaylistItemMousedown:function(){this.getCurrentSmSound().setPosition(0);this.play()}});